call mtr.add_suppression("Cannot connect to xpand.*");

CREATE DATABASE xpd;
USE xpd;

CREATE TABLE t (i INT PRIMARY KEY) ENGINE=XPand;
CREATE TABLE u (i INT PRIMARY KEY);
INSERT INTO t VALUES (1);
INSERT INTO u VALUES (1);
SELECT * FROM t ORDER BY i;
SELECT * FROM u ORDER BY i;
SELECT TABLE_SCHEMA, TABLE_NAME FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA = 'xpd' AND TABLE_NAME IN ('t', 'u') ORDER BY TABLE_SCHEMA, TABLE_NAME;
SELECT TABLE_SCHEMA, TABLE_NAME FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_SCHEMA = 'xpd' AND TABLE_NAME IN ('t', 'u') ORDER BY TABLE_SCHEMA, TABLE_NAME;

SET @xpand_hosts = @@xpand_hosts;
SET @xpand_port = @@xpand_port;
SET GLOBAL xpand_hosts = CONCAT('notahost,', @xpand_hosts);
connect (conn2,localhost,root,,xpd);
connection conn2;

SHOW CREATE TABLE t;
SHOW CREATE TABLE u;
INSERT INTO t values (2);
INSERT INTO u values (2);
SELECT * FROM t ORDER BY i;
SELECT * FROM u ORDER BY i;
SELECT TABLE_SCHEMA, TABLE_NAME FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA = 'xpd' AND TABLE_NAME IN ('t', 'u') ORDER BY TABLE_SCHEMA, TABLE_NAME;
SELECT TABLE_SCHEMA, TABLE_NAME FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_SCHEMA = 'xpd' AND TABLE_NAME IN ('t', 'u') ORDER BY TABLE_SCHEMA, TABLE_NAME;

disconnect conn2;
connection default;
SET GLOBAL xpand_hosts = '127.0.0.1';
SET GLOBAL xpand_port = 1;
connect (conn3,localhost,root,,xpd);
connection conn3;

SHOW CREATE TABLE t;
SHOW CREATE TABLE u;
--error ER_GET_ERRNO
INSERT INTO t values (3);
INSERT INTO u values (3);
--error ER_GET_ERRNO
SELECT * FROM t ORDER BY i;
SELECT * FROM u ORDER BY i;
SELECT TABLE_SCHEMA, TABLE_NAME FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA = 'xpd' AND TABLE_NAME IN ('t', 'u') ORDER BY TABLE_SCHEMA, TABLE_NAME;
SELECT TABLE_SCHEMA, TABLE_NAME FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_SCHEMA = 'xpd' AND TABLE_NAME IN ('t', 'u') ORDER BY TABLE_SCHEMA, TABLE_NAME;

disconnect conn3;
connection default;
SET GLOBAL xpand_hosts = @xpand_hosts;
SET GLOBAL xpand_port = @xpand_port;

SHOW CREATE TABLE t;
SHOW CREATE TABLE u;
INSERT INTO t VALUES (4);
INSERT INTO u VALUES (4);
SELECT * FROM t ORDER BY i;
SELECT * FROM u ORDER BY i;
SELECT TABLE_SCHEMA, TABLE_NAME FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA = 'xpd' AND TABLE_NAME IN ('t', 'u') ORDER BY TABLE_SCHEMA, TABLE_NAME;
SELECT TABLE_SCHEMA, TABLE_NAME FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_SCHEMA = 'xpd' AND TABLE_NAME IN ('t', 'u') ORDER BY TABLE_SCHEMA, TABLE_NAME;

USE test;
DROP DATABASE xpd;
