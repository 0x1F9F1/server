#
# MDEV-22985 Assertion `!(thd->rgi_slave && thd->rgi_slave->did_mark_start_commit)' failed in ha_rollback_trans#
#
#

--source include/have_log_bin.inc
--source include/have_innodb.inc
--source include/master-slave.inc
#set global binlog_split_alter=true;
--connection slave
stop slave;
SET global slave_parallel_threads=2;
set global slave_parallel_mode=optimistic;
start slave;
--connection master
 
CREATE TABLE t1 (i int primary key) ENGINE = InnoDB;
--connection master1 
ALTER  TABLE t1 DROP PRIMARY KEY;
ALTER  TABLE t1 ADD UNIQUE KEY ui (i);
--error 1280 ###?  query 'ALTER  TABLE t1 ADD PRIMARY KEY ( i )' failed: 1280: Incorrect index name 'ui'
ALTER  TABLE t1 ADD PRIMARY KEY (i);
show binlog events;
 
--sync_slave_with_master
 
--connection master
drop table t1;
set global binlog_split_alter=false;

--connection slave
--source include/stop_slave.inc
SET global slave_parallel_threads=0;
set global slave_parallel_mode=conservative;
--source include/start_slave.inc

--source include/rpl_end.inc
