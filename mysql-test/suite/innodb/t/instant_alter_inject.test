--source include/have_innodb.inc
--source include/have_debug.inc
--source include/have_partition.inc

CREATE TABLE t1(a INT PRIMARY KEY, b INT, KEY(b)) ENGINE=InnoDB
PARTITION BY KEY() PARTITIONS 3;
INSERT INTO t1 (a) VALUES (1),(2),(3),(4),(5);
SET @saved_dbug= @@SESSION.debug_dbug;
SET DEBUG_DBUG='+d,ib_commit_inplace_fail_2';
--error ER_INTERNAL_ERROR
ALTER TABLE t1 ADD COLUMN c CHAR(3) DEFAULT 'lie';
SET DEBUG_DBUG= @saved_dbug;
BEGIN;
UPDATE t1 SET b=a+1;
INSERT INTO t1 VALUES (0,1);
ROLLBACK;
SELECT * FROM t1;
ALTER TABLE t1 ADD COLUMN c CHAR(3) DEFAULT 'lie';
SET DEBUG_DBUG='+d,ib_commit_inplace_fail_1';
# FIXME: This crashes in rollback!
#--error ER_INTERNAL_ERROR
#ALTER TABLE t1 ADD COLUMN d INT NOT NULL DEFAULT -42;
SET DEBUG_DBUG= @saved_dbug;
BEGIN;
DELETE FROM t1;
INSERT INTO t1 VALUES (1,2,'foo');
ROLLBACK;

SHOW CREATE TABLE t1;
DROP TABLE t1;
