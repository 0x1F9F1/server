create or replace table t(id int, s date, e date, val int,
period for p(s,e),
unique(id, p without overlaps));
insert into t values (1, '2003-01-01', '2003-03-01', 1),
(1, '2003-05-01', '2003-07-01', 2);
# This just inserts a row; no rows matched
insert into t values (2, '2003-01-01', '2003-04-01', 3)
on duplicate key update val=4;
select * from t;
id	s	e	val
1	2003-01-01	2003-03-01	1
1	2003-05-01	2003-07-01	2
2	2003-01-01	2003-04-01	3
insert into t values (1, '2003-01-05', '2003-04-01', 5)
on duplicate key update val=6;
select row_count();
row_count()
2
select * from t;
id	s	e	val
1	2003-01-05	2003-03-01	6
1	2003-05-01	2003-07-01	2
2	2003-01-01	2003-04-01	3
insert into t values (1, '2003-01-01', '2003-06-01', 7)
on duplicate key update val=8;
select row_count();
row_count()
4
select * from t;
id	s	e	val
1	2003-01-05	2003-03-01	8
1	2003-05-01	2003-06-01	8
2	2003-01-01	2003-04-01	3
# No rows matched
insert into t values (1, '2003-07-01', '2003-08-01', 9)
on duplicate key update val=10;
select row_count();
row_count()
1
select * from t;
id	s	e	val
1	2003-01-05	2003-03-01	8
1	2003-05-01	2003-06-01	8
1	2003-07-01	2003-08-01	9
2	2003-01-01	2003-04-01	3
replace into t values (1, '2003-02-01', '2003-05-05', 11);
select row_count();
row_count()
5
select * from t;
id	s	e	val
1	2003-01-05	2003-02-01	8
1	2003-02-01	2003-05-05	11
1	2003-05-05	2003-06-01	8
1	2003-07-01	2003-08-01	9
2	2003-01-01	2003-04-01	3
# Single row insert
replace into t values(2, '2003-06-01', '2003-08-01', 12);
select row_count();
row_count()
1
select * from t;
id	s	e	val
1	2003-01-05	2003-02-01	8
1	2003-02-01	2003-05-05	11
1	2003-05-05	2003-06-01	8
1	2003-07-01	2003-08-01	9
2	2003-01-01	2003-04-01	3
2	2003-06-01	2003-08-01	12
replace into t values(2, '2003-02-01', '2003-09-01', 13);
select row_count();
row_count()
4
select * from t;
id	s	e	val
1	2003-01-05	2003-02-01	8
1	2003-02-01	2003-05-05	11
1	2003-05-05	2003-06-01	8
1	2003-07-01	2003-08-01	9
2	2003-01-01	2003-02-01	3
2	2003-02-01	2003-09-01	13
delete from t where val=13;
insert into t values(2, '2003-06-01', '2003-08-01', 14);
select * from t;
id	s	e	val
1	2003-01-05	2003-02-01	8
1	2003-02-01	2003-05-05	11
1	2003-05-05	2003-06-01	8
1	2003-07-01	2003-08-01	9
2	2003-01-01	2003-02-01	3
2	2003-06-01	2003-08-01	14
replace into t values(2, '2003-02-01', '2003-07-01', 15);
select row_count();
row_count()
3
select * from t;
id	s	e	val
1	2003-01-05	2003-02-01	8
1	2003-02-01	2003-05-05	11
1	2003-05-05	2003-06-01	8
1	2003-07-01	2003-08-01	9
2	2003-01-01	2003-02-01	3
2	2003-02-01	2003-07-01	15
2	2003-07-01	2003-08-01	14
select 2, '2003-01-15', '2003-07-15', 16 into outfile 'tmp_t.txt';
load data infile 'tmp_t.txt' into table t;
ERROR 23000: Duplicate entry '2-2003-07-15-2003-01-15' for key 'id'
load data infile 'tmp_t.txt' replace into table t;
select * from t;
id	s	e	val
1	2003-01-05	2003-02-01	8
1	2003-02-01	2003-05-05	11
1	2003-05-05	2003-06-01	8
1	2003-07-01	2003-08-01	9
2	2003-01-01	2003-01-15	3
2	2003-01-15	2003-07-15	16
2	2003-07-15	2003-08-01	14
insert t select 2, '2003-01-07', '2003-09-01', 17
on duplicate key update val = 18;
select * from t;
id	s	e	val
1	2003-01-05	2003-02-01	8
1	2003-02-01	2003-05-05	11
1	2003-05-05	2003-06-01	8
1	2003-07-01	2003-08-01	9
2	2003-01-07	2003-01-15	18
2	2003-01-15	2003-07-15	18
2	2003-07-15	2003-08-01	18
replace t select 2, '2003-01-07', '2003-09-01', 19;
select * from t;
id	s	e	val
1	2003-01-05	2003-02-01	8
1	2003-02-01	2003-05-05	11
1	2003-05-05	2003-06-01	8
1	2003-07-01	2003-08-01	9
2	2003-01-07	2003-09-01	19
# Double execution
replace t values (2, '2003-01-01', '2003-01-10', 20),
(2, '2003-05-01', '2003-08-01', 20);
select * from t;
id	s	e	val
1	2003-01-05	2003-02-01	8
1	2003-02-01	2003-05-05	11
1	2003-05-05	2003-06-01	8
1	2003-07-01	2003-08-01	9
2	2003-01-01	2003-01-10	20
2	2003-01-10	2003-05-01	19
2	2003-05-01	2003-08-01	20
2	2003-08-01	2003-09-01	19
prepare stmt from "insert t values (2, '2003-01-05', '2003-07-10', 21) on duplicate key update val= val+1";
execute stmt;
select * from t;
id	s	e	val
1	2003-01-05	2003-02-01	8
1	2003-02-01	2003-05-05	11
1	2003-05-05	2003-06-01	8
1	2003-07-01	2003-08-01	9
2	2003-01-05	2003-01-10	22
2	2003-01-10	2003-05-01	20
2	2003-05-01	2003-07-10	21
2	2003-08-01	2003-09-01	19
execute stmt;
select * from t;
id	s	e	val
1	2003-01-05	2003-02-01	8
1	2003-02-01	2003-05-05	11
1	2003-05-05	2003-06-01	8
1	2003-07-01	2003-08-01	9
2	2003-01-05	2003-01-10	23
2	2003-01-10	2003-05-01	21
2	2003-05-01	2003-07-10	22
2	2003-08-01	2003-09-01	19
deallocate prepare stmt;
# Autoincrement
alter table t add pk int primary key auto_increment;
replace t(id, s, e, val) values (2, '2003-06-01', '2003-08-15', 23);
select * from t;
id	s	e	val	pk
1	2003-01-05	2003-02-01	8	1
1	2003-02-01	2003-05-05	11	5
1	2003-05-05	2003-06-01	8	2
1	2003-07-01	2003-08-01	9	4
2	2003-01-05	2003-01-10	23	7
2	2003-01-10	2003-05-01	21	6
2	2003-05-01	2003-06-01	22	9
2	2003-06-01	2003-08-15	23	11
2	2003-08-15	2003-09-01	19	10
insert t(id, s, e, val) values (2, '2003-05-15', '2003-08-20', 24)
on duplicate key update val = 25;
select * from t;
id	s	e	val	pk
1	2003-01-05	2003-02-01	8	1
1	2003-02-01	2003-05-05	11	5
1	2003-05-05	2003-06-01	8	2
1	2003-07-01	2003-08-01	9	4
2	2003-01-05	2003-01-10	23	7
2	2003-01-10	2003-05-01	21	6
2	2003-05-15	2003-06-01	25	9
2	2003-06-01	2003-08-15	25	11
2	2003-08-15	2003-08-20	25	10
drop table t;
