set storage_engine='tokudb';
set global tokudb_lock_timeout=1000000;
drop table if exists t;
create table t (a int primary key, b int);
insert into t values (1, 1);
insert into t values (2, 4);
insert into t values (3, 9);
insert into t values (4, 16);
set autocommit=off;
set session transaction isolation level serializable;
begin;
select * from t where a=1 for update;
a	b
1	1
set session transaction isolation level serializable;
select * from t where a=1;
ERROR HY000: Lock wait timeout exceeded; try restarting transaction
select * from t where a=2;
a	b
2	4
select * from t where a=3;
a	b
3	9
select * from t where a=4;
a	b
4	16
commit;
select * from t;
a	b
1	1
2	4
3	9
4	16
begin;
select * from t where a<=2 for update;
a	b
1	1
2	4
select * from t where a=1;
ERROR HY000: Lock wait timeout exceeded; try restarting transaction
select * from t where a>1;
ERROR HY000: Lock wait timeout exceeded; try restarting transaction
select * from t;
ERROR HY000: Lock wait timeout exceeded; try restarting transaction
select * from t where a=4;
a	b
4	16
commit;
select * from t;
a	b
1	1
2	4
3	9
4	16
begin;
replace into t values(1, 10),(3,30);
select * from t where a=1;
ERROR HY000: Lock wait timeout exceeded; try restarting transaction
select * from t where a=3;
ERROR HY000: Lock wait timeout exceeded; try restarting transaction
select * from t where a=2;
a	b
2	4
select * from t where a=4;
a	b
4	16
commit;
select * from t;
a	b
1	10
2	4
3	30
4	16
drop table t;
set global tokudb_lock_timeout=30000000;
select @@tokudb_lock_timeout;
@@tokudb_lock_timeout
30000000
